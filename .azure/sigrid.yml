# Trigger on PR to dev branch
pr:
  branches:
    include:
      - dev

# Disable CI trigger
trigger: none

stages:
  - stage: SigridAnalysis
    displayName: "Sigrid Code Quality Analysis"
    jobs:
      - job: SigridReportAndPublish
        displayName: "Generate Report and Publish"
        pool:
          vmImage: ubuntu-latest
        container: softwareimprovementgroup/sigridci:azure
        continueOnError: true
        steps:
          - bash: |
              echo "Running Sigrid analysis with comprehensive security scanning..."
              echo "Source branch: $(Build.SourceBranchName)"
              echo "Target branch: $(System.PullRequest.TargetBranch)"

              # Check for Sigrid configuration
              if [ -f ".sigrid.yml" ]; then
                echo "Found Sigrid configuration:"
                cat .sigrid.yml
              fi

              # List all files with potential vulnerabilities
              echo ""
              echo "Files containing security vulnerabilities:"
              echo "========================================="
              find . -name "*.js" -o -name "*.ts" | grep -E "(vulnerable|crypto|security)" | head -20
              echo ""

              # Run comprehensive Sigrid analysis
              sigridci.py \
                --customer basicfit \
                --system migration-playground \
                --source . \
                --publish \
                --exclude "node_modules,coverage,test-results,.next"
            displayName: "Run Sigrid CI Analysis and Publish"
            env:
              SIGRID_CI_TOKEN: $(SIGRID_CI_TOKEN)
            continueOnError: true

          - bash: |
              echo "Sigrid analysis completed!"
              echo "Check the Sigrid dashboard for detailed results."
            displayName: "Analysis Summary"
            condition: always()
